name: CD - Deploy to AWS Elastic Beanstalk

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    # Only deploy if CI passes
    needs: []  # Add 'test' here once CI job exists, like: needs: [test]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Install Elastic Beanstalk CLI
        run: pip install awsebcli

      - name: Deploy to Elastic Beanstalk
        run: |
          # Initialize EB if not already done
          eb init model-registry --region ${{ secrets.AWS_REGION || 'us-east-1' }} --platform "Python 3.11" --non-interactive || true
          
          # Deploy to environment (creates if doesn't exist)
          eb deploy model-registry-production --non-interactive --timeout 30 || eb create model-registry-production --timeout 30

      - name: Get deployment URL
        run: |
          eb status model-registry-production
          eb list

      - name: Health check
        run: |
          URL=$(eb status model-registry-production | grep "CNAME" | awk '{print $2}')
          echo "Deployed to: http://$URL"
          curl -f http://$URL/health || exit 1

